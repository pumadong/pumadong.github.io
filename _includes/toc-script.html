document.addEventListener("DOMContentLoaded", function() {
  const postContent = document.querySelector('.post-content');
  const tocContent = document.getElementById('toc-content');
  
  if (!postContent || !tocContent) return;

  // 1. 获取所有标题 (h1, h2, h3)
  const headings = postContent.querySelectorAll('h1, h2, h3');
  if (headings.length === 0) {
    document.getElementById('toc-container').style.display = 'none';
    return;
  }

  const tocList = document.createElement('ul');

  headings.forEach((heading, index) => {
    // 确保标题有 ID，否则创建一个
    if (!heading.id) {
      heading.id = 'heading-' + index;
    }

    const listItem = document.createElement('li');
    listItem.style.marginLeft = (heading.tagName === 'H3' ? '15px' : '0px');

    const link = document.createElement('a');
    link.href = '#' + heading.id;
    link.textContent = heading.textContent;
    link.dataset.targetId = heading.id;

    listItem.appendChild(link);
    tocList.appendChild(listItem);
  });

  tocContent.appendChild(tocList);

  // 2. 滚动监听：高亮当前标题
  const tocLinks = tocContent.querySelectorAll('a');
  
  window.addEventListener('scroll', () => {
    let currentId = '';
    const scrollPos = window.scrollY + 120; // 偏移量

    headings.forEach(heading => {
      if (scrollPos > heading.offsetTop) {
        currentId = heading.id;
      }
    });

    tocLinks.forEach(link => {
      link.classList.remove('active');
      if (link.dataset.targetId === currentId) {
        link.classList.add('active');
      }
    });
  });
});