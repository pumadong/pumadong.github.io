<script>
document.addEventListener("DOMContentLoaded", function() {
  const content = document.querySelector('#markdown-content');
  const toc = document.querySelector('#toc');
  const headings = content.querySelectorAll('h1, h2, h3');
  
  if (headings.length === 0) return;

  const tocList = document.createElement('ul');

  headings.forEach((heading, index) => {
    // 确保标题有 ID
    if (!heading.id) {
      heading.id = 'heading-' + index;
    }

    const li = document.createElement('li');
    const a = document.createElement('a');
    a.href = '#' + heading.id;
    a.textContent = heading.textContent;
    a.classList.add('toc-link');
    
    // 根据 H 级别添加缩进
    li.style.marginLeft = (heading.tagName === 'H3' ? '1rem' : '0');
    
    li.appendChild(a);
    tocList.appendChild(li);
  });

  toc.appendChild(tocList);

  // 滚动监听高亮
  const observerOptions = {
    root: null,
    rootMargin: '0px 0px -80% 0px',
    threshold: 0
  };

  const observer = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        document.querySelectorAll('.toc-link').forEach(link => {
          link.classList.remove('active');
        });
        const activeLink = document.querySelector(`.toc-link[href="#${entry.target.id}"]`);
        if (activeLink) activeLink.classList.add('active');
      }
    });
  }, observerOptions);

  headings.forEach(heading => observer.observe(heading));
});
</script>