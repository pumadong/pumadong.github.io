---
layout: post
title: "AWS从入门到精通"
---

# IAM - Identity and Access Management

简单来说，IAM 解决的是两个核心问题：**你是谁？（认证）** 以及 **你能干什么？（授权）**

在 AWS 的权限管理体系（IAM - Identity and Access Management）中，**User（用户）**、**Group（用户组）**、**Policy（策略）** 和 **Role（角色）** 是最核心的四个概念。

为了让你直观理解，我们可以把 AWS 比作一家**大型公司办公大楼**。

------

## 1. User (用户) —— “员工工卡”

**User** 代表一个具体的人或应用程序。每个 User 都有自己的登录凭证（用户名/密码或 Access Key）。

- **特点：** 长期存在的实体。
- **类比：** 公司里的入职员工“小明”。小明有自己的工卡，用来进入大楼。

## 2. Group (用户组) —— “部门”

**Group** 是 User 的集合。你不需要给每个员工单独发权限，而是把员工放进某个“部门”，该部门的所有人就自动拥有了相同的权限。

- **特点：** 简化管理。你不能直接用 Group 登录，它只是用来组织 User 的。
- **类比：** “财务部”。只要小明被调入财务部，他就自动获得了查看报表的权力，不需要行政单独给他开通。

------

## 3. Policy (策略) —— “权限说明书”

**Policy** 是一个 JSON 格式的文档，定义了“谁”可以对“什么资源”执行“什么操作”。

- **特点：** 它本身不具备任何效力，必须**附加（Attach）**到 User、Group 或 Role 上。
- **类比：** 一张“门禁权限清单”，上面写着：*允许进入 3 楼茶水间，禁止进入 5 楼机房*。

------

## 4. Role (角色) —— “临时通行证 / 职务”

**Role** 可能是最容易混淆的概念。它类似于 User，因为它也是一种身份，但它**没有**密码或长期密钥。它是供人或服务**临时扮演（Assume）**的。

- **特点：** 临时性、安全性高。常用于跨账号访问、赋予 EC2 实例权限或给第三方使用。
- **类比：** “值班经理”。
  - “值班经理”不是某个人，而是一个**岗位**。
  - 小明（User）在白天戴上“值班经理”的袖标（扮演 Role），就获得了处理紧急情况的权限；下班摘掉袖标，权限消失。

------

## 四者的核心区别与联系

------

### 总结：它们是如何协同工作的？

1. 你编写了一个 **Policy**（定义了只能重启服务器的权限）。
2. 你创建了一个 **Group** 叫 "运维组"，并将这个 Policy 关联给它。
3. 你创建了一个 **User** 叫 "老王"，把老王拉进 "运维组"。老王现在可以重启服务器了。
4. 某天老王需要临时处理数据库，你让他 **Assume（扮演）** 一个拥有数据库权限的 **Role**，处理完后，老王变回普通运维。

## Authentication[认证] Authorization[鉴权]

### AuthN和AuthZ协同工作

当你（Principal）尝试操作 AWS 资源（如读取一个 S3 桶里的文件）时，流程如下：

1. **认证 (AuthN)**：AWS 首先检查你的身份。你提供的密码或密钥对吗？如果对，通过。
2. **上下文收集**：AWS 查看你是谁（User）、你在哪个组（Group）、或者你正在扮演哪个角色（Role）。
3. **策略评估 (AuthZ)**：AWS 会搜索所有挂载在这些身份上的 **Policies**。
   - **显式拒绝 (Explicit Deny)**：如果有任何一条策略说“禁止访问 S3”，直接拒绝（优先级最高）。
   - **显式允许 (Allow)**：如果没有拒绝，且有一条策略说“允许读取 S3”，则操作成功。
   - **默认拒绝 (Implicit Deny)**：如果既没说允许也没说拒绝，默认是不准操作的。

### AuthN和AuthZ总结与建议

- **不要给用户直接分配权限**：尽量通过“组”来管理，这样人员变动时只需移动组即可。
- **优先使用角色 (Role)**：对于给服务器（EC2）或 Lambda 授权，绝对不要把 Access Key 写死在代码里，而是给服务器关联一个 Role。
- **最小权限原则**：只给员工完成工作所需的最低限度权限，不要为了图省事给每个人都挂 `AdministratorAccess`。

## IAM 最佳实践指南

## 1. 核心安全原则

#### 最小特权原则 (PoLP)

- **只给必须的权限：** 仅授予用户完成工作所需的最低权限。
- **避免使用 Root/Admin 账号：** 日常操作严禁使用根账号，应创建具有特定权限的 IAM 用户。
- **按需授权 (JIT)：** 实施“及时访问”，即权限仅在任务执行期间有效，任务结束后自动撤销。

#### 零信任架构 (Zero Trust)

- **永不信任，始终验证：** 无论是在内网还是外网，每一次请求都必须经过身份验证、授权和加密。
- **多维度验证：** 除了密码，还要检查登录地点、设备状态、请求时间等上下文信息。

------

### 2. 身份认证最佳实践

#### 强制执行多因素认证 (MFA)

- **抗钓鱼 MFA：** 优先使用硬件安全密钥（如 FIDO2/YubiKey）或通行密钥（Passkeys），避免仅依赖 SMS 短信验证。
- **全员覆盖：** 不仅仅是管理员，普通员工和合作伙伴也应开启 MFA。

#### 推进“去密码化”

- 利用 **Biometrics（生物识别）** 和 **Magic Links** 减少密码泄露风险，同时提升员工办公体验。

------

### 3. 权限管理与治理

#### 基于角色的访问控制 (RBAC) 与 基于属性的访问控制 (ABAC)

- **RBAC：** 按职位（如“财务”、“开发”）分配权限，适合标准化的组织结构。
- **ABAC：** 结合属性（如“仅允许在工作时间、从公司 IP 访问敏感数据”）进行更精细的控制。

#### 自动化入职与离职流程

- **自动同步 HR 系统：** 当员工入职、调岗或离职时，系统应自动创建、更改或禁用其访问权限，防止“孤儿账号”产生。

------

### 4. 持续审计与监控

------

### 5. 云服务商（AWS/Azure/GCP）差异化建议

- **AWS：** 善用 **IAM Access Analyzer** 来发现并修复对外公开的资源权限。
- **Azure：** 深度整合 **Entra ID (原 Azure AD)**，利用条件访问策略（Conditional Access）进行动态风控。
- **GCP：** 利用其清晰的**资源层级结构**（组织 > 文件夹 > 项目）进行权限继承管理。

# EC2 - Amazon Elastic Compute Cloud

## 什么是EC2

简单来说，**EC2 (Amazon Elastic Compute Cloud)** 是亚马逊 AWS 提供的**云端虚拟服务器**。

你可以把它想象成一台“运行在云端的电脑”。以前公司想要运行软件或网站，需要买物理服务器、拉网线、关在空调房里维护；现在通过 EC2，你只需要在网页上点几下，几分钟内就能租到一台配置好的电脑。

------

### 1. 名字里的玄机

- **Elastic（弹性）：** 这是它最大的特点。你可以随时根据需要增加（横向扩展）或减少服务器数量，也可以随时升级或降级配置（CPU、内存）。
- **Compute（计算）：** 指的是它提供的是处理能力。
- **Cloud（云）：** 意味着这些资源存在于亚马逊全球的数据中心里，你通过互联网访问。

### 2. EC2 的核心组成

当你创建一个 EC2 实例（Instance）时，通常需要配置以下几项：

- **AMI (系统镜像)：** 相当于“系统安装盘”，决定了这台电脑装 Windows 还是 Linux。
- **实例类型：** 决定了 CPU 和内存的大小（如 `t3.micro` 适合轻量测试，`c5` 适合高性能计算）。
- **EBS (存储)：** 相当于“硬盘”，用来存数据。
- **安全组 (Security Group)：** 相当于“虚拟防火墙”，控制谁能访问这台机器。

### 3. 为什么大家都用它？

| **优势**       | **描述**                                                     |
| -------------- | ------------------------------------------------------------ |
| **按需付费**   | 用一分钟付一分钟的钱，不用了直接关掉，不浪费。               |
| **几分钟部署** | 不需要等待硬件发货，几分钟就能启动成百上千台服务器。         |
| **高可用性**   | 亚马逊在全球都有数据中心，你可以把服务器放在美国、东京或北京。 |
| **完全控制**   | 你拥有这台虚拟机的 Root/管理员权限，想装什么软件随你。       |

## EC2 实例类型

Amazon EC2（Elastic Compute Cloud）提供了数百种不同的实例类型，每种类型都针对特定的计算需求（如内存密集型、计算密集型或存储密集型）进行了优化。

我们可以通过一个简单的“命名公式”来快速理解它们。

### 1. 实例命名规则详解

EC2 的名称通常由三部分组成，例如：`m5.2xlarge` 或 `c7g.medium`。

- **系列 (Family):** 第一个字母。代表它的“主要能力”（如 **M** 代表通用，**C** 代表计算）。
- **代数 (Generation):** 紧跟其后的数字。数字越大，硬件越新，通常性价比越高（如 **7** 比 **6** 性能更好、价格更优）。
- **其他特性 (Attributes):** 小写后缀字母。
  - **a**: 代表使用 AMD 处理器。
  - **g**: 代表使用 AWS Graviton（ARM 架构）处理器，性价比通常最高。
  - **i**: 代表使用 Intel 处理器。
  - **d**: 代表带有本地 NVMe 临时存储（Instance Store）。
- **规格 (Size):** 点号后的部分（如 `large`, `2xlarge`）。规格越大，分配的 CPU、内存和网络带宽越多。

------

### 2. 核心实例类别对照表

根据你的业务场景，可以参考下表进行选择：

| **类别**                           | **常见前缀** | **适用场景**                             | **特点**                                     |
| ---------------------------------- | ------------ | ---------------------------------------- | -------------------------------------------- |
| **通用型 (General Purpose)**       | **T, M**     | 网站后端、开发环境、中小型数据库         | 资源最平衡，**T 系列**支持性能突增（最便宜） |
| **计算优化型 (Compute Optimized)** | **C**        | 视频转码、高性能科学计算、游戏服务器     | 侧重 CPU，适合需要高算力的任务               |
| **内存优化型 (Memory Optimized)**  | **R, X, Z**  | In-memory 数据库（如 Redis）、大数据处理 | 侧重 RAM，适合处理大型数据集                 |
| **存储优化型 (Storage Optimized)** | **I, D, H**  | 分布式文件系统、NoSQL 数据库             | 极高的本地磁盘 IOPS 或大容量存储             |
| **加速计算型 (Accelerated)**       | **P, G, F**  | 机器学习（AI）、图形渲染、视频剪辑       | 搭载 NVIDIA GPU 或 FPGA 加速卡               |

------

### 3. 如何选择合适的实例？

如果你不确定从哪开始，可以遵循以下**“三步走”策略**：

1. **首选通用型：** 如果是新项目，先从 **t3** (测试用) 或 **m6i / m7g** (生产用) 开始。
2. **看资源短缺：** 运行一段时间后观察监控。如果 CPU 经常 100% 但内存很空，换成 **C 系列**；如果内存不够用，换成 **R 系列**。
3. **优先使用 Graviton (g后缀)：** 只要你的代码（如 Python, Java, Go, Node.js）能跑在 Linux ARM 上，切换到 `m7g` 或 `c7g` 通常能直接省下约 20% 的成本。

### 4. 购买模式（省钱秘籍）

除了选择类型，购买方式对价格影响巨大：

- **按需 (On-Demand):** 随时开停，最贵。适合短期、不可预测的任务。
- **预留实例/节省计划 (RI/Savings Plans):** 承诺使用 1-3 年，可获得 **3-6 折** 优惠。
- **竞价实例 (Spot Instances):** 利用 AWS 空闲资源，最高 **1 折**。但 AWS 随时可能回收，适合无状态、可中断的任务（如渲染、批处理）。

## EC2的区域（Region）

在 AWS (Amazon Web Services) 的基础架构中，**区域 (Region)** 和 **可用区 (Availability Zone, AZ)** 是构建可靠、高可用应用的基石。理解这两者的关系对于部署 EC2 实例至关重要。

------

### 1. 核心概念解析

#### 区域 (Region)

区域是地理上的一个独立区域（例如“东京”、“弗吉尼亚北部”）。

- **地理隔离**：每个区域完全独立，旨在提供最高级别的容错能力和稳定性。
- **合规性**：用户可以根据数据驻留法律（如 GDPR）选择将数据存储在特定区域。
- **延迟优化**：通常选择距离客户最近的区域以减少网络延迟。

#### 可用区 (Availability Zone)

每个区域内包含多个孤立的位置，称为“可用区”。

- **物理隔离**：每个 AZ 都有独立的电力、冷却和物理安全性。
- **高速互联**：同一区域内的不同 AZ 之间通过高带宽、低延迟的专用网络连接。
- **容错设计**：将 EC2 部署在多个 AZ 中，可以防止因单个数据中心故障导致的服务中断。

------

### 2. 区域与可用区的命名规则

AWS 使用代号来标识这些位置，方便在 API 和 CLI 中调用：

| **类型**       | **示例名称**     | **说明**                      |
| -------------- | ---------------- | ----------------------------- |
| **区域代码**   | `us-east-1`      | 美国东部（弗吉尼亚北部）      |
| **区域代码**   | `ap-northeast-1` | 亚太地区（东京）              |
| **可用区代码** | `us-east-1a`     | 区域代码后缀字母 (a, b, c...) |

------

### 3. 如何选择合适的区域？

在创建 EC2 实例时，选择区域通常基于以下四个维度：

1. **延迟（Latency）**：选择最靠近用户的区域。
2. **成本（Cost）**：不同区域的实例价格可能不同（例如，美国区域通常比圣保罗区域便宜）。
3. **服务可用性**：并非所有 AWS 服务在每个区域都可用（新功能通常先在 `us-east-1` 上线）。
4. **法律合规**：某些受监管的行业要求数据必须留在特定国家境内。

------

### 4. EC2 部署的最佳实践

- **多可用区部署**：不要将所有 EC2 实例放在同一个可用区（如 `us-east-1a`）。使用 **弹性负载均衡 (ELB)** 将流量分发到两个或多个 AZ 的实例上。
- **区域间备份**：如果需要应对极端的灾难（如整个城市级别的故障），可以使用 **AMI 复制** 功能将镜像备份到另一个地理区域。
- **端点连接**：访问 EC2 服务时，请确保配置了正确的区域端点（Endpoint），例如 `ec2.us-west-2.amazonaws.com`。

## EC2简单实践

### 新建EC2实例

1. Instances -> Launch Instances

2. 操作系统选择ubuntu

3. Create key pair，my-test-key/my-test-key.pem，SSH到机器用的用户名和私钥

4. 几秒之后，机器处于Running状态，1分钟左右，机器初始化完毕

5. chmod 400 "mykey1.pem"

6. ssh -i "mykey1.pem" ubuntu@ec2-13-250-238-183.ap-southeast-1.compute.amazonaws.com

7. 安装Java和Jenkins：

   ```
   sudo su -
   # 安装jenkins依赖的java版本，安装jenkins，参考官网
   https://www.jenkins.io/doc/book/installing/linux/#debianubuntu
   systemctl status jenkins	# 可以看到jenkins安装成功
   配置本机的InBound Rules，增加开放8080端口
   ```

8. 浏览器访问：http://IP:8080/，jenkins已经正常启动，在8080端口提供Web服务。

### 比较好的SSH工具

https://termius.com/

https://iterm2.com/

https://mobaxterm.mobatek.net/

### Review IAM - SendSSHPublicKey

新建用户组development-group，赋予AmazonEC2FullAccess策略。

新建用户test-user-501，归属于development-group

使用test-user-501，执行以上新建EC2实例操作，会发现不论控制台，还是远程SSH都是练不上的。

```
Bobs-MacBook-Pro:Downloads bob$ nc -zv 18.138.11.170 22
Connection to 18.138.11.170 port 22 [tcp/ssh] succeeded!

命令各部分含义
nc: 是 netcat 的缩写，被誉为网络工具中的“瑞士军刀”，用于读写网络连接。
-z: 告诉程序只扫描端口，不发送任何数据。它仅用于探测端口状态。
-v: 表示 Verbose（详细模式）。它会让命令输出更详细的信息，告诉你连接是成功还是失败。
18.138.11.170: 这是你要探测的目标服务器的 IP 地址。
22: 这是你要检查的 端口号。端口 22 通常是 SSH（远程登录）服务的默认端口。
```

用root也可以在控制台连接成功，说明一定是 **IAM 用户的权限配置**。

虽然 `AmazonEC2FullAccess` 听起来像是拥有了 EC2 的“所有权限”，但它主要涵盖的是对 EC2 资源本身的生命周期管理（如：启动、停止、删除、修改安全组）。

**EC2 Instance Connect (EIC)** 实际上被视为一个独立的辅助服务。在 AWS 的权限体系中，通过控制台“一键连接”实例的行为，涉及到一个关键动作：**向实例推送临时 SSH 公钥**。这个动作的权限并不包含在标准的 `AmazonEC2FullAccess` 中。

------

#### 为什么 `AmazonEC2FullAccess` 无法连接？

我们可以对比一下这两个权限的范畴：

| **权限名称**             | **涵盖的操作**                                               | **目的**                                         |
| ------------------------ | ------------------------------------------------------------ | ------------------------------------------------ |
| **AmazonEC2FullAccess**  | `ec2:RunInstances`, `ec2:TerminateInstances`, `ec2:AuthorizeSecurityGroupIngress` 等 | **管理机器**：开关机、改配置、设防火墙。         |
| **EC2 Instance Connect** | `ec2-instance-connect:SendSSHPublicKey`                      | **进入机器**：把你的“钥匙”塞进实例的临时内存里。 |

简单比喻：

AmazonEC2FullAccess 给了你这栋大楼的所有权，你可以盖楼、拆墙、甚至停电；但进入房间的“门禁卡系统”是由另一套权限管理的，你手里的钥匙（IAM 凭证）如果没有在门禁系统里注册，依然进不去。

------

#### 如何解决？

你需要给这个 IAM 用户额外增加一个 **“权限边界”以外的特定授权**。你可以通过以下两种方式之一来解决：

##### 方案 A：添加 AWS 托管策略（最快）

在 IAM 用户权限页面，点击“添加权限”，直接搜索并附加：

- **`AWSIoTDeviceTesterForAmazonFreeRTOSFullAccess`** (虽然名字不直观，但它包含 EIC 权限)
- 或者更推荐的做法：**创建一个自定义策略。**

##### 方案 B：创建自定义内联策略（最推荐，安全）

将以下 JSON 贴入该用户的内联策略中，这能精准解决 `Access denied` 问题：

JSON

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "ec2-instance-connect:SendSSHPublicKey",
            "Resource": "*"
        }
    ]
}
```

------

#### 总结

你之所以报错，是因为你的 IAM 用户虽然有权“拥有”这台机器，但无权“推钥匙”进机器。

**请尝试添加 `ec2-instance-connect:SendSSHPublicKey` 权限，通常添加后几秒钟内就会生效。**

# VPC - Virtual Private Cloud

## VPC基础

### 什么是VPC

简单来说，**AWS VPC (Virtual Private Cloud)** 是你在亚马逊云（AWS）上的**私人虚拟网络**。

如果把 AWS 想象成一个巨大的公共停车场，那么 VPC 就是在这个停车场里为你专门围起来的一个**私有车库**。在这个空间里，你可以完全掌控网络环境，包括选择 IP 地址范围、创建子网、配置路由表和网络网关。

------

### VPC 的核心组件

为了让你更好地理解它是如何运作的，我们可以看下它的几个关键部分：

- **子网 (Subnets)：** 你可以将 VPC 划分为多个子网。通常分为**公有子网**（可以访问互联网，如放网站服务器）和**私有子网**（无法直接访问互联网，如放数据库）。
- **路由表 (Route Tables)：** 相当于“交通警察”，决定网络流量的去向。
- **互联网网关 (Internet Gateway)：** 连接 VPC 和互联网的桥梁。
- **安全组 (Security Groups) & 网络 ACL：** 相当于“虚拟防火墙”，控制进出服务器的流量，确保安全。

------

### 为什么要使用 VPC？

1. **安全性与隔离：** 你的资源与其他用户的资源在逻辑上是完全隔离的。即使在云端，你的数据也像在自家机房一样安全。
2. **完全的控制权：** 你可以自定义网络配置。例如，你可以指定哪些服务器可以被外界访问，哪些只能在内网沟通。
3. **灵活的连接方式：** 你可以通过 VPN 或专用连接（Direct Connect）将你的办公室机房与 AWS VPC 连在一起，形成**混合云**架构。

------

### 举个例子

假设你要运行一个电商网站：

- **Web 服务器**：放在**公有子网**，这样用户才能通过浏览器访问。
- **数据库**：放在**私有子网**，严禁互联网直接访问，只允许 Web 服务器读取数据。
- **VPC**：就是包裹这两者的安全边界。

> **提示：** 默认情况下，你在 AWS 创建账号后，每个区域都会有一个“默认 VPC”，让你能快速上手。但对于生产环境，建议手动创建符合业务需求的自定义 VPC。

## 企业上AWS时VPC实践

在企业级应用中，AWS VPC（虚拟私有云）不仅是承载业务的底层网络，更是安全与合规的第一道防线。根据 2025 年最新的 AWS 最佳实践，企业上云时的 VPC 设计应遵循“分层防御、自动化治理、高可用性”的原则。

以下是企业上 AWS 时 VPC 实践的深度指南：

------

### 1. 网络规划与 IP 地址管理 (IPAM)

对于企业而言，IP 地址冲突是后期扩展的最大障碍。

- **避免 IP 重叠：** 必须确保 VPC 的 CIDR范围与本地数据中心或其他 VPC 的 CIDR 不冲突。
- **使用 AWS IPAM：** 2025 年的趋势是使用 **Amazon VPC IPAM**（IP 地址管理器）自动规划、追踪和监控 IP 使用情况，避免手动 Excel 管理带来的风险。
- **预留空间：** 为未来的业务扩展（如容器化、Lambda 接口）预留足够的 CIDR 空间。

### 2. 标准化多层子网架构

典型的企业级 VPC 应至少分为三层：

- **公有子网 (Public Subnet)：** 仅部署面向外部的资源，如 ALB（负载均衡器）和 NAT 网关。
- **私有子网 (Private Subnet)：** 部署应用服务器。外部无法直接访问，需通过 ALB 或 NAT。
- **数据库子网 (Data Subnet)：** 专门用于数据库和敏感存储，实施最严苛的 NACL 和安全组策略。

### 3. 高可用性 (High Availability) 设计

- **跨可用区 (Multi-AZ)：** 始终在至少两个（推荐三个）可用区中部署子网。
- **NAT 网关冗余：** 在每个可用区分别部署 NAT 网关。避免单个 NAT 网关跨可用区流量产生的额外延迟和单点故障。

### 4. 混合云与跨 VPC 互联

随着企业规模扩大，单一 VPC 已不足以支撑。

- **Transit Gateway (TGW)：** 当 VPC 数量超过 3-5 个时，使用 TGW 作为中央枢纽，简化 Hub-and-Spoke（星型）拓扑管理。
- **VPC Peering：** 仅适用于少数 VPC 之间的点对点高性能通信。
- **AWS Direct Connect：** 用于企业数据中心与 AWS 之间的低延迟专用物理连接。

### 5. 深度安全与监控

- **VPC 端点 (VPC Endpoints/PrivateLink)：** **这是 2025 年的关键实践**。尽量通过 PrivateLink 访问 AWS 服务（如 S3, DynamoDB），而非经过公有互联网，这能显著降低数据脱离风险并节省 NAT 流量费用。

- **安全组 vs NACL：** 

  - **安全组 (Security Groups)：** 实例级的状态化防火墙，实施“最小权限原则”。

  - **NACLs：** 子网级的无状态防火墙，作为最后的防线（如黑名单特定 IP）。

  - **核心区别对比表：**

    | **特性**     | **网络 ACL (NACL)**                                          | **网络安全组 (Security Group / NSG)**                     |
    | ------------ | ------------------------------------------------------------ | --------------------------------------------------------- |
    | **作用范围** | **子网 (Subnet)** 级别                                       | **实例 (Instance / NIC)** 级别                            |
    | **有状态性** | **无状态 (Stateless)**：请求进去后，响应回来也必须有规则放行。 | **有状态 (Stateful)**：请求被放行后，响应会自动允许返回。 |
    | **规则类型** | 支持 **允许 (Allow)** 和 **拒绝 (Deny)**。                   | 仅支持 **允许 (Allow)**（不匹配即拒绝）。                 |
    | **执行顺序** | 按规则编号 **从小到大** 顺序评估。                           | 评估所有规则后决定是否允许。                              |
    | **默认状态** | 默认通常允许所有进出流量。                                   | 默认拒绝所有入站流量，允许所有出站。                      |

- **流量监控：** 必须开启 **VPC Flow Logs** 并将其发送至 CloudWatch 或 S3，配合 **GuardDuty** 进行异常流量检测（如扫描行为、数据泄露）。

------

### 6.快速核查表

| **实践维度**   | **推荐方案**                                   |
| -------------- | ---------------------------------------------- |
| **IP 分配**    | 使用私有 RFC 1918 地址段，严禁与 IDC 冲突      |
| **互联网访问** | 严格限制公有子网，私有资源使用 NAT 网关        |
| **合规性**     | 启用 AWS Config 监控 VPC 配置变更              |
| **成本优化**   | 优先使用 Gateway 端点（S3/DynamoDB）以节省费用 |

## NACL配置的意义与实践

在 AWS 等云服务中，**默认 NACL（Network ACL）** 的配置是“允许所有流量”（Allow All）。

但 NACL 的配置意义在于**从“默认允许”向“按需配置”转变**，以及处理**无状态（Stateless）**过滤。以下是配置 NACL “允许”规则的核心意义：

### 1. 配合“拒绝”规则实现精细化控制

NACL 是按**规则编号（Rule Number）**从小到大顺序匹配的。如果你想封禁某个恶意 IP 段，但允许其他所有流量，你就需要配置：

- **规则 100：** 拒绝 (Deny) 来自 `1.2.3.4/32` 的流量。

- 规则 200： 允许 (Allow) 所有流量。

  如果没有“允许”规则，流量匹配完拒绝规则后，最终会落入 NACL 末尾隐藏的 “默认拒绝（Deny All）” 规则中。

------

### 2. “自定义 NACL” 的初始状态是全拒绝

这可能是最关键的一点：

- **默认 NACL：** 确实是默认允许所有（为了让新手快速上手不至于断网）。
- **自定义 NACL：** 当你手动创建一个新的 NACL 并关联到子网时，它的默认状态是**拒绝所有流量**。此时，你必须手动添加“允许”规则，否则该子网内的所有实例都会失联。

------

### 3. 处理“无状态（Stateless）”的回程流量

这是 NACL 与安全组（Security Group）最大的区别。

- **安全组是“有状态”的：** 你允许了请求进来，响应流量自动就能出去。

- NACL 是“无状态”的： 你允许了 80 端口进入，必须手动配置允许临时端口（Ephemeral Ports，通常是 1024-65535）出去。

  如果你不配置这些“允许”规则，即便请求进来了，服务器的响应也发不出去，导致连接超时。

------

### 4. 建立“白名单”安全模型（零信任）

在生产环境中，防御者通常会删除“允许所有”的规则，转而采用**“最小权限原则”**：

1. 删除默认的 `0.0.0.0/0 Allow`。
2. 仅配置允许特定的端口（如 80, 443）。
3. 这样，任何未被明确允许的流量（如黑客扫描的其他端口）都会被拦截。

### 总结：NACL 规则对比表

| **特性**         | **默认 NACL**                    | **自定义 NACL**                 |
| ---------------- | -------------------------------- | ------------------------------- |
| **初始入站规则** | 允许所有 (Allow All)             | **拒绝所有 (Deny All)**         |
| **初始出站规则** | 允许所有 (Allow All)             | **拒绝所有 (Deny All)**         |
| **主要用途**     | 快速开始，后期增加黑名单（Deny） | 严格管控，仅配置白名单（Allow） |

## VPC简单实践

![VPC架构图](https://cdn.jsdelivr.net/gh/pumadong/assets@master/aws/vpc-architecture.png)

1. **新建VPC demo-vpc (先使用默认配置)**

   - 选择“VPC and more”，目的是同时生成子网/网关/路由表等网络资源
   - 默认两个可用区
   - 每个可用区public subnet/private subnet各一个，所以4个subnet
   - 两个public subnet共用一个route table，所以3个route table
   - public subnet/private subnet各有自己的网关，所以2个gateway


2. **生成instance demo-instance**

   - os使用ubuntu
   - kei pair还是使用mykey1
   - network settings
     - vpc改成我们刚才新建的demo-vpc
     - subnet选一个public subnet
     - auto-assign public ip，选择enabled


3. **SSH到新建的ec2，安装软件**

   - sudo apt update

   - ```
     nohup python3 -m http.server 8000 > output.log 2>&1 &
     > output.log: 日志存到这里。
     2>&1: 把错误信息也存进去。
     &: 放入后台运行。
     ```

   - 不要直接运行 python3 -m http.server 8000，配置较低的实例（如 t2.micro），启动服务时如果触发大量 IO，可能导致系统为了保护自身而杀掉 SSH 进程，这样就只能重启ec2实例了


4. **配置ec2实例的安全组，inbound rule增加8000端口**

5. **http://公网IP:8000/，可以正常访问**

6. **VPC配置Network ACLs**

   - nacl默认入站/出站都是打开的，配置一个no是100的全允许，和no是\*的全拒绝，no小的生效后，就不会继续寻找其他规则，所以no是\*的规则不会走到
   - 增加一个no是80的8000端口的入站拒绝规则，http://公网IP:8000/不能访达
   - 我们把rule number改成120或者删除，http://公网IP:8000/正常访达


7. **以上操作简单演示VPC的结构，nacl和security group的关系。**

# Amazon Route 53

Amazon Route 53 是 AWS 提供的一种**高可用、高可扩展的云端域名系统 (DNS) 网络服务**。它的名字来源于 TCP/UDP 的 53 端口（DNS 服务标准端口）。

它的主要作用可以概括为以下四个核心维度：

------

## 1. 域名注册 (Domain Registration)

Route 53 可以作为一个域名注册商。你可以直接在控制台搜索并购买域名（如 `example.com`）。

- **自动化管理：** 购买后，Route 53 会自动为该域名配置 DNS 解析设置。
- **续费与锁：** 支持自动续费和防止恶意转出的域名锁定功能。

## 2. DNS 解析 (Public & Private DNS)

这是其最基础的功能，负责将人类易读的域名翻译成机器识别的 IP 地址。

- **公共 DNS：** 将互联网流量引导至你的网站、负载均衡器（ALB）、S3 存储桶等。
- **私有 DNS：** 允许你在 VPC（虚拟私有云）内使用自定义域名，而不必将这些域名暴露在公网。

## 3. 流量路由策略 (Routing Policies)

这是 Route 53 最强大的地方，它能根据不同的需求决定将用户引导至哪个服务器：

| **策略类型**                      | **作用描述**                                           |
| --------------------------------- | ------------------------------------------------------ |
| **简单路由 (Simple)**             | 最基础的 1 对 1 或 1 对多映射。                        |
| **加权路由 (Weighted)**           | 按比例分配流量（常用于 A/B 测试或蓝绿部署）。          |
| **延迟路由 (Latency)**            | 根据网络延迟，将用户引导至访问速度最快的 AWS 区域。    |
| **地理位置路由 (Geolocation)**    | 根据用户的地理位置（如：欧洲用户访问欧洲服务器）导向。 |
| **故障转移路由 (Failover)**       | 当主服务器宕机时，自动切换到备用服务器。               |
| **多值应答 (Multi-value Answer)** | 类似健康检查，返回多个健康的 IP 地址以提高可用性。     |

## 4. 健康检查 (Health Checks)

Route 53 可以监控你的应用、服务器或终端节点的“健康状态”。

- **自动剔除：** 如果某个服务器出现故障，Route 53 会识别到并自动停止向该点发送流量，将请求转发到健康的资源。
- **监控报警：** 可以与 CloudWatch 结合，在端点失效时通过邮件或短信提醒运维人员。

------

### 总结：为什么用 Route 53？

相比传统的 DNS 服务商，Route 53 的优势在于：

1. **100% 可用性 SLA：** 它是 AWS 极少数承诺 100% 可用的服务之一。
2. **与 AWS 深度集成：** 可以无缝连接别名记录（Alias Record）到 ELB、CloudFront 和 S3。
3. **全球化网络：** 拥有遍布全球的边缘节点，确保解析速度极快。
